<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Casier sécurisé</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui;}
    body{background:#f5f5f7;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;}
    .container{
      background:white;padding:32px;border-radius:22px;border:1px solid #e5e7eb;
      width:100%;max-width:420px;box-shadow:0 10px 30px rgba(0,0,0,0.1);
    }
    .title{text-align:center;font-size:1.6rem;font-weight:700;margin-bottom:6px;}
    .subtitle{text-align:center;font-size:.9rem;color:#6b7280;margin-bottom:22px;}

    .code-display{
      text-align:center;font-size:1.5rem;letter-spacing:10px;background:#f9fafb;
      padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:6px;
    }
    .status{text-align:center;font-size:1rem;margin-bottom:12px;color:#6b7280;}
    .status.error{color:#dc2626;} .status.success{color:#16a34a;}

    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:10px;}
    .btn{
      padding:16px 0;border-radius:14px;border:1px solid #ddd;background:#fff;
      font-size:1.2rem;cursor:pointer;font-weight:600;
    }
    .btn:hover{background:#eef2ff;border-color:#c7d2fe;}
    
    .btn-ok{background:#22c55e;color:white;border:none;}
    .btn-clear{background:#fee2e2;color:#b91c1c;}

    .final-panel{
      margin-top:20px;padding:16px;border-radius:14px;background:#ecfdf5;
      border:1px solid #bbf7d0;display:none;
    }
    .final-btn{
      margin-top:14px;width:100%;padding:14px;border:none;border-radius:999px;
      background:#22c55e;color:white;font-size:1rem;font-weight:600;
    }
  </style>
</head>
<body>

<div class="container">

  <div class="title">Casier sécurisé</div>
  <div class="subtitle" id="subtitleLocker"></div>

  <div id="codeDisplay" class="code-display">____</div>
  <div id="status" class="status">Saisissez le code reçu.</div>

  <div class="keypad" id="keypad">
    <button class="btn" data-num="1">1</button>
    <button class="btn" data-num="2">2</button>
    <button class="btn" data-num="3">3</button>
    <button class="btn" data-num="4">4</button>
    <button class="btn" data-num="5">5</button>
    <button class="btn" data-num="6">6</button>
    <button class="btn" data-num="7">7</button>
    <button class="btn" data-num="8">8</button>
    <button class="btn" data-num="9">9</button>
    <button class="btn btn-clear" id="clearBtn">C</button>
    <button class="btn" data-num="0">0</button>
    <button class="btn btn-ok" id="okBtn">OK</button>
  </div>

  <div class="final-panel" id="finalPanel">
    <b>Casier ouvert ✔️</b><br><br>
    Ouvrez, récupérez votre trottinette et refermez le casier.
    <button class="final-btn" id="confirmCloseBtn">Confirmer fermeture</button>
  </div>

</div>

<script>
const params=new URLSearchParams(window.location.search);
const secretCode=params.get("code");
const lockerName=params.get("locker");
const trottId=params.get("trott");

document.getElementById("subtitleLocker").textContent=`${lockerName} · ${trottId}`;
document.getElementById("codeDisplay").textContent="____";

let current="";

function updateDisplay(){
  document.getElementById("codeDisplay").textContent=current.padEnd(secretCode.length,"_");
}
updateDisplay();

document.querySelectorAll("[data-num]").forEach(btn=>{
  btn.onclick=()=>{
    if(current.length<secretCode.length){
      current+=btn.dataset.num;
      updateDisplay();
    }
  };
});

document.getElementById("clearBtn").onclick=()=>{
  current="";
  updateDisplay();
};

document.getElementById("okBtn").onclick=()=>{
  if(current===secretCode){
    document.getElementById("status").textContent="Code correct ✔️";
    document.getElementById("status").className="status success";
    document.getElementById("finalPanel").style.display="block";
  } else {
    document.getElementById("status").textContent="Code incorrect ❌";
    document.getElementById("status").className="status error";
  }
};

document.getElementById("confirmCloseBtn").onclick=()=>{
  // HISTORIQUE
  const hist=JSON.parse(localStorage.getItem("lockerHistory")||"[]");
  const now=new Date();
  const str=now.toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
  hist.push({date:str,locker:lockerName,trott:trottId,code:secretCode});
  localStorage.setItem("lockerHistory",JSON.stringify(hist));

  // REDIRECTION
  setTimeout(()=>{window.location.href="final.html";},1000);
};

/* PWA */
if("serviceWorker" in navigator){navigator.serviceWorker.register("sw.js");}
</script>

</body>
</html>
